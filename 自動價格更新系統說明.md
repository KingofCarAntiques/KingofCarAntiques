# 秒估車 - 自動價格更新系統 v3.0

## 系統概述

本系統會**每月1日凌晨2點（台灣時間）**自動執行，從多個來源收集最新車價數據並更新網站。

```
┌─────────────────────────────────────────────────────────────┐
│                    自動更新流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│   │  8891    │    │ ABC好車網 │    │Google    │            │
│   │ 汽車網   │    │          │    │Sheets    │            │
│   │ (權重50%)│    │ (權重30%)│    │ (權重20%)│            │
│   └────┬─────┘    └────┬─────┘    └────┬─────┘            │
│        │               │               │                   │
│        └───────────────┼───────────────┘                   │
│                        ▼                                   │
│              ┌──────────────────┐                         │
│              │   價格整合引擎    │                         │
│              │ • 異常值過濾     │                         │
│              │ • 加權平均計算   │                         │
│              └────────┬─────────┘                         │
│                       ▼                                   │
│              ┌──────────────────┐                         │
│              │   car-data.js    │                         │
│              │   自動更新       │                         │
│              └──────────────────┘                         │
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 快速開始

### 方法一：自動執行（推薦）

系統會在每月1日自動執行，無需手動操作。

### 方法二：手動觸發

1. 前往 GitHub 儲存庫
2. 點擊 **Actions** 標籤
3. 選擇 **「每月自動更新車輛價格」**
4. 點擊 **「Run workflow」** 按鈕

### 方法三：本地測試

```bash
cd scripts
npm install
node price-scraper-multi-source.js
```

---

## Google Sheets 整合設定（可選）

如果您想要手動維護一份價格數據作為參考來源，可以設定 Google Sheets 整合。

### 步驟一：建立 Google Sheets

1. 前往 [Google Sheets](https://sheets.google.com)
2. 建立新的試算表
3. 設定以下欄位格式：

| A 欄（品牌） | B 欄（車款） | C 欄（價格） |
|-------------|-------------|-------------|
| Toyota豐田  | Altis       | 650000      |
| Toyota豐田  | Camry       | 1100000     |
| Honda本田   | CR-V        | 980000      |
| BMW         | 3 Series    | 1800000     |

### 步驟二：發布為 CSV

1. 點擊 **檔案** → **共用** → **發布到網路**
2. 選擇 **整份文件** 或特定工作表
3. 格式選擇 **逗號分隔值 (.csv)**
4. 點擊 **發布**
5. 複製產生的連結

### 步驟三：設定 GitHub Secrets

1. 前往 GitHub 儲存庫 → **Settings** → **Secrets and variables** → **Actions**
2. 點擊 **New repository secret**
3. 名稱：`GOOGLE_SHEET_CSV_URL`
4. 值：貼上步驟二的 CSV 連結
5. 點擊 **Add secret**

---

## 數據來源說明

### 1. 8891 汽車網（權重 50%）

- 台灣最大的中古車交易平台
- 使用 Puppeteer 爬取搜尋結果頁面
- 提取多筆同款車型的價格取平均值

### 2. ABC 好車網（權重 30%）

- 另一個主要的中古車平台
- 使用 Cheerio 解析 HTML
- 作為交叉驗證的數據來源

### 3. Google Sheets（權重 20%）

- 您手動維護的價格參考
- 可用於補充特殊車款數據
- 例如：從「石貳全行情表」手動輸入

---

## 價格計算邏輯

### 1. 數據收集
```
Toyota Altis 價格收集：
  8891：65萬、68萬、62萬、70萬 → 平均 66.25萬
  ABC：64萬、67萬 → 平均 65.5萬
  Google Sheets：65萬
```

### 2. 異常值過濾

- 排除偏離中位數超過 30% 的價格
- 例如：如果一個來源顯示 200萬，而其他都是 65萬左右，則排除 200萬

### 3. 加權平均計算

```
最終價格 = (8891價格 × 0.5) + (ABC價格 × 0.3) + (Sheets價格 × 0.2)
         = (662500 × 0.5) + (655000 × 0.3) + (650000 × 0.2)
         = 331250 + 196500 + 130000
         = 657750 → 四捨五入 = 658000
```

### 4. 變化檢查

- 如果新價格與舊價格相差超過 30%，則視為異常，不更新
- 這可防止爬蟲錯誤導致價格劇烈變動

---

## 檔案結構

```
scripts/
├── price-scraper-multi-source.js  # 主要爬蟲程式 ⭐
├── package.json                    # 依賴設定
├── scraper.log                     # 執行日誌
├── price-results.json              # 更新結果報告
└── backups/                        # 自動備份目錄
    └── car-data_2026-01-01.js

.github/workflows/
└── update-prices.yml               # GitHub Actions 設定
```

---

## 執行日誌範例

```
[2026-01-01T18:00:00.000Z] [INFO] ========================================
[2026-01-01T18:00:00.000Z] [INFO] 🚀 秒估車 - 多來源價格更新系統 v3.0
[2026-01-01T18:00:00.000Z] [INFO] ========================================
[2026-01-01T18:00:01.000Z] [INFO] ✅ 載入車款資料庫：51 個品牌
[2026-01-01T18:00:02.000Z] [INFO] 🌐 啟動瀏覽器...
[2026-01-01T18:00:05.000Z] [INFO] 📊 處理品牌: Toyota豐田 (45 款車型)
[2026-01-01T18:00:08.000Z] [INFO] 🔍 [8891] 查詢: Toyota豐田 Altis
[2026-01-01T18:00:12.000Z] [SUCCESS] [8891] Toyota豐田 Altis: 650,000 元 (樣本數: 15)
[2026-01-01T18:00:15.000Z] [INFO] 🔍 [ABC好車網] 查詢: Toyota豐田 Altis
[2026-01-01T18:00:18.000Z] [SUCCESS] [ABC] Toyota豐田 Altis: 645,000 元 (樣本數: 8)
[2026-01-01T18:00:18.000Z] [SUCCESS] ✅ Toyota豐田 Altis: 660,000 → 648,000 (-1.82%)
...
[2026-01-01T18:45:00.000Z] [INFO] ========================================
[2026-01-01T18:45:00.000Z] [INFO] 📊 執行統計
[2026-01-01T18:45:00.000Z] [INFO] ========================================
[2026-01-01T18:45:00.000Z] [INFO] 總品牌數: 51
[2026-01-01T18:45:00.000Z] [INFO] 處理車款: 510
[2026-01-01T18:45:00.000Z] [INFO] 成功更新: 423
[2026-01-01T18:45:00.000Z] [INFO] 跳過: 72
[2026-01-01T18:45:00.000Z] [INFO] 失敗: 15
[2026-01-01T18:45:00.000Z] [INFO] 執行時間: 45.0 分鐘
[2026-01-01T18:45:00.000Z] [INFO] ========================================
```

---

## 常見問題

### Q1: 爬蟲失敗怎麼辦？

**A:** 可能原因：
1. 網站結構變更 → 需要更新選擇器
2. 被網站封鎖 → 調整請求頻率
3. 網路問題 → 重新執行即可

### Q2: 價格看起來不對？

**A:** 檢查步驟：
1. 查看 `scripts/price-results.json` 了解更新細節
2. 查看 `scripts/scraper.log` 了解執行過程
3. 從備份還原：`scripts/backups/car-data_YYYY-MM-DD.js`

### Q3: 如何增加新的數據來源？

**A:** 在 `price-scraper-multi-source.js` 中：
1. 新增爬蟲函數（參考 `scrape8891` 或 `scrapeABC`）
2. 在 `CONFIG.SOURCE_WEIGHTS` 中設定權重
3. 在主流程中調用新函數

### Q4: 如何調整更新頻率？

**A:** 修改 `.github/workflows/update-prices.yml` 中的 cron 設定：
```yaml
schedule:
  - cron: '0 18 1 * *'    # 每月1日
  - cron: '0 18 1,15 * *' # 每月1日和15日
  - cron: '0 18 * * 0'    # 每週日
```

---

## 技術支援

如有問題，請檢查：
1. GitHub Actions 執行日誌
2. `scripts/scraper.log` 檔案
3. `scripts/price-results.json` 更新報告

---

**最後更新：2026年1月**
