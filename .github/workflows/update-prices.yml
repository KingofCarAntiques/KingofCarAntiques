# ===============================================
# ç§’ä¼°è»Š - æ¯æœˆè‡ªå‹•æ›´æ–°åƒ¹æ ¼å·¥ä½œæµç¨‹
# ===============================================
# ğŸ“… åŸ·è¡Œæ™‚é–“ï¼šæ¯æœˆ1æ—¥å‡Œæ™¨ 2:00 (å°ç£æ™‚é–“)
# ğŸ”„ åŠŸèƒ½ï¼šè‡ªå‹•çˆ¬å– 8891ã€è¡Œå°‡æ‹è³£ç­‰æ•¸æ“šä¸¦æ›´æ–°è»Šåƒ¹
# ===============================================

name: æ¯æœˆè‡ªå‹•æ›´æ–°è»Šè¼›åƒ¹æ ¼

on:
  # æ¯æœˆ1æ—¥å‡Œæ™¨2é»åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ï¼‰
  schedule:
    - cron: '0 18 1 * *'  # UTC 18:00 = å°ç£æ™‚é–“éš”æ—¥ 02:00

  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  update-car-prices:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºä»£ç¢¼
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è¨­å®š Node.js ç’°å¢ƒ
      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3. å®‰è£ä¾è³´å¥—ä»¶
      - name: ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
        run: |
          cd scripts
          npm install

      # 4. åŸ·è¡Œåƒ¹æ ¼çˆ¬èŸ²
      - name: ğŸ•·ï¸ çˆ¬å–æœ€æ–°è»Šåƒ¹æ•¸æ“š
        run: |
          cd scripts
          node scraper-improved.js
        env:
          NODE_ENV: production

      # 5. æ›´æ–° car-data.js
      - name: ğŸ“ æ›´æ–°è»Šåƒ¹è³‡æ–™åº«
        run: |
          cd scripts
          node update-car-data-improved.js

      # 6. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      - name: ğŸ” æª¢æŸ¥æª”æ¡ˆè®Šæ›´
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      # 7. æäº¤è®Šæ›´
      - name: ğŸ’¾ æäº¤åƒ¹æ ¼æ›´æ–°
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add car-data.js
          git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°è»Šåƒ¹ - $(date +'%Yå¹´%mæœˆ')"
          git push

      # 8. å®Œæˆé€šçŸ¥
      - name: âœ… æ›´æ–°å®Œæˆ
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "âœ… è»Šåƒ¹å·²æˆåŠŸæ›´æ–°è‡³ $(date +'%Yå¹´%mæœˆ') ç‰ˆæœ¬"

      - name: â„¹ï¸ ç„¡éœ€æ›´æ–°
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "â„¹ï¸ åƒ¹æ ¼ç„¡è®ŠåŒ–ï¼Œç„¡éœ€æ›´æ–°"
