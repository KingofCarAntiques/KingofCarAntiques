# ===============================================
# ç§’ä¼°è»Š - æ¯æœˆè‡ªå‹•æ›´æ–°åƒ¹æ ¼å·¥ä½œæµç¨‹ v3.0
# ===============================================
# ğŸ“… åŸ·è¡Œæ™‚é–“ï¼šæ¯æœˆ1æ—¥å‡Œæ™¨ 2:00 (å°ç£æ™‚é–“)
# ğŸ”„ åŠŸèƒ½ï¼šå¤šä¾†æºçˆ¬å–è»Šåƒ¹æ•¸æ“šï¼ˆ8891ã€ABCå¥½è»Šç¶²ï¼‰
# ğŸ›¡ï¸ ç‰¹è‰²ï¼šç•°å¸¸å€¼éæ¿¾ã€åŠ æ¬Šå¹³å‡ã€è‡ªå‹•å‚™ä»½
# ===============================================

name: æ¯æœˆè‡ªå‹•æ›´æ–°è»Šè¼›åƒ¹æ ¼

on:
  # æ¯æœˆ1æ—¥å‡Œæ™¨2é»åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ = UTC+8ï¼‰
  schedule:
    - cron: '0 18 1 * *'  # UTC 18:00 = å°ç£æ™‚é–“éš”æ—¥ 02:00

  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨èª¿è©¦æ¨¡å¼'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  update-car-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æœ€é•·åŸ·è¡Œ60åˆ†é˜

    steps:
      # 1. æª¢å‡ºä»£ç¢¼
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      # 2. è¨­å®š Node.js ç’°å¢ƒ
      - name: ğŸ”§ è¨­å®š Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      # 3. å®‰è£ä¾è³´å¥—ä»¶
      - name: ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶
        run: |
          cd scripts
          npm ci || npm install
          echo "âœ… ä¾è³´å¥—ä»¶å®‰è£å®Œæˆ"

      # 4. å®‰è£ Puppeteer æ‰€éœ€çš„ç³»çµ±ä¾è³´
      - name: ğŸ”§ å®‰è£ Puppeteer ç³»çµ±ä¾è³´
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2
          echo "âœ… Puppeteer ç³»çµ±ä¾è³´å®‰è£å®Œæˆ"

      # 5. åŸ·è¡Œå¤šä¾†æºåƒ¹æ ¼çˆ¬èŸ²
      - name: ğŸ•·ï¸ åŸ·è¡Œå¤šä¾†æºåƒ¹æ ¼çˆ¬èŸ²
        run: |
          cd scripts
          echo "ğŸš€ é–‹å§‹åŸ·è¡Œåƒ¹æ ¼çˆ¬èŸ²..."
          node price-scraper-multi-source.js
        env:
          NODE_ENV: production
          GOOGLE_SHEET_CSV_URL: ${{ secrets.GOOGLE_SHEET_CSV_URL }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        continue-on-error: false

      # 6. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      - name: ğŸ” æª¢æŸ¥æª”æ¡ˆè®Šæ›´
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain car-data.js) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æª¢æ¸¬åˆ° car-data.js æœ‰è®Šæ›´"
            git diff --stat car-data.js || true
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ car-data.js ç„¡è®Šæ›´"
          fi

      # 7. ä¸Šå‚³åŸ·è¡Œæ—¥èªŒï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
      - name: ğŸ“‹ ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            scripts/scraper.log
            scripts/price-results.json
          retention-days: 30

      # 8. æäº¤è®Šæ›´
      - name: ğŸ’¾ æäº¤åƒ¹æ ¼æ›´æ–°
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add car-data.js
          git add scripts/price-results.json || true
          COMMIT_MSG="ğŸ”„ è‡ªå‹•æ›´æ–°è»Šåƒ¹ - $(TZ='Asia/Taipei' date +'%Yå¹´%mæœˆ%dæ—¥')

          ğŸ“Š æ•¸æ“šä¾†æºï¼š8891æ±½è»Šç¶²ã€ABCå¥½è»Šç¶²
          ğŸ¤– ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ"

          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… è®Šæ›´å·²æäº¤ä¸¦æ¨é€"

      # 9. åŸ·è¡Œçµæœæ‘˜è¦
      - name: ğŸ“Š åŸ·è¡Œçµæœæ‘˜è¦
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“Š åŸ·è¡Œçµæœæ‘˜è¦"
          echo "=========================================="
          echo "åŸ·è¡Œæ™‚é–“: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S') (å°ç£æ™‚é–“)"
          echo "è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
          echo "æœ‰è®Šæ›´: ${{ steps.check_changes.outputs.changes }}"
          echo "=========================================="

      # 10. å¤±æ•—é€šçŸ¥
      - name: ğŸš¨ å¤±æ•—é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ åƒ¹æ ¼æ›´æ–°å¤±æ•—ï¼"
          echo "è«‹æª¢æŸ¥åŸ·è¡Œæ—¥èªŒ"
